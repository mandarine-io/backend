# Компоненты

Наверное самое важное в системе Mandarine - ее составляющие. Немного подробнее о них:

## Сервер

**Сервер** - это монолитное приложение на языке [*Golang*](https://go.dev/). Монолит содержит в себе *логически
разделенные модули*,
которые впоследствии при расширении можно быстро разделить на отдельные проекты.

![server-modules](./_assets/server-modules.png 'Модули монолита')

Сервер состоит из следующих модулей:

+ **Auth** - отвечает за идентификацию, аутентификацию и управление доступами пользователей (вход и выход из системы,
  регистрация, восстановление пароля).
+ **Account** - ответственен за управление аккаунтом (получение информации об аккаунте, смена имени пользователя/адреса
  электронной почты/пароля).
+ **Master Profile** - позволяет создать и управлять профилем мастера.
+ **Master Service** - дает возможность добавлять услуги мастера и изменять их параметры (цену, продолжительность,
  описание).
+ **Master Portfolio** - управляет портфолио мастера, включая добавление, редактирование и удаление работ, которые
  демонстрируют навыки и выполненные проекты.
+ **Master Appointment** - обеспечивает управление записями мастера.
+ **Master History** - агрегирует и хранит историю всех записей мастера.
+ **Master Rating** - предоставляет возможность оценивать мастера, оставлять отзывы и получать рейтинг.
+ **Master Statistics** - собирает статистику о работах мастера и предоставляет ее.
+ **Client Profile** - обеспечивает создание и управление профилем клиента.
+ **Client Appointment** - предоставляет возможность записаться на услугу мастера.
+ **Client History** - хранит историю всех записей клиента.
+ **Geocoding** - предназначен для преобразования адресов в координаты и обратно.
+ **Resource** - управляет загрузкой, хранением и доступом к файлам, таким как изображения, документы и другие ресурсы.
+ **Websocket** - хранит Websocket соединения, что позволяет реализовать real-time уведомления.
+ **URL Shortener** - упрощает длинные ссылки, преобразуя их в короткие, удобные для распространения и анализа.
+ **Metrics** - отслеживает и предоставляет аналитическую информацию о производительности системы в формате
  *Prometheus*.
+ **Swagger** - обеспечивает интерактивную документацию для API в формате *Swagger*, позволяя разработчикам исследовать
  и тестировать
  конечные точки.

Используемые технологии:

- [**Gin WEB Framework**](https://gin-gonic.com/) - фреймворк для HTTP сервера.
- [**GORM**](https://gorm.io/index.html) - ORM для *Golang*. Используется дравер *PostgreSQL* и плагин кеширования.
- [**go-redis**](https://redis.uptrace.dev/) - клиент для работы с *Redis*. Позволяет реализовать кеш и Pub/Sub.
- [**minio-go**](https://min.io/docs/minio/linux/developers/go/minio-go.html?ref=docs-redirect) - клиент для работы с
  *MinIO*.
- [**gomail**](https://github.com/go-gomail/gomail) - дилер для отправки электронных писем.
- [**gocron**](https://github.com/go-co-op/gocron) - планировщик Cron-задач.
- [**gorilla/websocket**](https://github.com/gorilla/websocket) - библиотека для работы с *WebSockets*.

## База данных

![gopher-postgres-art](./_assets/gopher-postgres-art.png 'Подружили Gopher с PostgreSQL')

[**PostgreSQL**](https://www.postgresql.org/) - основная база данных системы Mandarine. Для удовлетворения всех
требований системы используется несколько ключевых возможностей PostgreSQL, которые делают его идеальным выбором:

+ [**PostGIS**](https://postgis.net/): Система активно использует расширение *PostGIS*, которое добавляет
  мощные инструменты для работы с географической информацией. Благодаря PostGIS реализованы следующие возможности:
  хранение координат, расчет расстояний, а также выполнение пространственных запросов.
+ **Полнотекстовый поиск**: Для реализации поиска по текстовым данным в системе (например, поиск мастеров по ключевым
  словам или услугам) используется механизм полнотекстового поиска, предоставляемый PostgreSQL. В основе этого механизма
  лежит индекс [*GIN (Generalized Inverted Index)*](https://www.postgresql.org/docs/current/gin.html).

## Кеш и Pub/Sub

![gopher-redis-art](./_assets/gopher-redis-art.png 'Gopher оседлал Redis')

[Redis](https://redis.io/) — это высокопроизводительная key-value база данных в памяти, которая используется в системе
Mandarine для нескольких ключевых задач:

+ **Кеш**: Redis предоставляет возможность хранения временных данных, что значительно ускоряет доступ к часто
  запрашиваемой информации. Модули используют кеш для хранения результатов запросов к БД и/или сторонним ресурсам.
+ **Pub/Sub**: Встроенная поддержка механизма публикации и подписки в Redis позволяет реализовать взаимодействие в
  режиме реального времени между различными модулями системы. Это особенно полезно для отправки уведомлений,
  синхронизации данных и передачи событий между модулями, такими как **Websocket** для уведомлений или **Metrics** для
  сбора аналитики.

## S3 хранилище

![gopher-s3-art](./_assets/gopher-s3-art.png 'Gopher собрал ведро файлов')

[**MinIO**](https://min.io/) — это масштабируемое и высокопроизводительное объектное хранилище, совместимое с Amazon S3
API. В системе Mandarine MinIO используется для хранения файлов, ПО позволяет безопасно сохранять изображения, документы
и другие ресурсы.

## Серверы авторизации OIDC

![gopher-oidc-art](./_assets/gopher-oidc-art.png 'Gopher собрал данные пользователей')

Система Mandarine поддерживает авторизацию через OIDC провайдеров, таких
как [**Google**](https://developers.google.com/identity/protocols/oauth2?hl=ru),
[**Yandex**](https://yandex.ru/dev/id/doc/ru/concepts/ya-oauth-intro)
и [**Mail.ru**](https://help.mail.ru/developers/oauth). Пользователи могут аутентифицироваться через свои аккаунты на
популярных платформах, что упрощает процесс регистрации и входа.

## Провайдеры геокодирования

![gopher-geocoding-art](./_assets/gopher-geocoding-art.png 'Gopher ищет нужное место')

Для реализации функционала геокодирования в системе Mandarine используется ряд
провайдеров: [**Graphhoper**](https://docs.graphhopper.com/),
[**Here**](https://developer.here.com/develop/rest-apis),
[**LocationIQ**](https://docs.locationiq.com/reference/search),
[**OpenStreetMap (Nominatim)**](https://nominatim.org/release-docs/latest/api/Overview/),
[**Yandex**](https://yandex.ru/dev/geocode/doc/ru/).

Для экономии квоты запросов к провайдерам геокодирования в системе Mandarine используется кэширование результатов и
Round-Robin балансировка между всеми провайдерами.

## API gateway

![gopher-traefik-art](./_assets/gopher-traefik-art.png 'Gopher шифрует трафик')

[**Traefik**](https://traefik.io/traefik/) — это современный маршрутизатор и балансировщик нагрузки, который
используется в системе Mandarine для:

+ **Маршрутизации запросов**: Traefik управляет распределением входящих HTTP и WebSocket запросов между сервисами и
  модулями монолита. Это позволяет скрыть сложность внутренней архитектуры от внешних пользователей.
+ **Поддержки SSL/TLS**: Traefik автоматически генерирует и обновляет сертификаты
  [**Let's Encrypt**](https://letsencrypt.org/ru/), обеспечивая безопасное соединение через HTTPS.
+ **Мониторинга, трассировки и логирования**: Интеграция Traefik с [**Prometheus**](https://prometheus.io/) и [
  **Jaeger**](https://www.jaegertracing.io/) позволяет собирать спаны и метрики производительности, а логирование
  запросов помогает в отладке и анализе системы.
+ **Масштабируемости**: Traefik поддерживает динамическое управление конфигурацией, что упрощает добавление новых
  модулей и сервисов.
